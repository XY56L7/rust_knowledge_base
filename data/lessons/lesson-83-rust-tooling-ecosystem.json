{
  "id": "lesson-83-rust-tooling-ecosystem",
  "title": "Rust Tooling Ecosystem: Cargo, Rustfmt, Clippy, and CI/CD",
  "description": "Master Rust's development tools: advanced Cargo features, Rustfmt, Clippy linter, documentation tools, testing frameworks, and CI/CD pipelines.",
  "content": "# Rust Tooling Ecosystem: Cargo, Rustfmt, Clippy, and CI/CD\n\nRust's tooling ecosystem makes development efficient and enjoyable.\n\n## Cargo Advanced Features\n\n### Workspaces\n\n**Workspaces** allow managing multiple related packages together.\n\n```toml\n# Cargo.toml (workspace root)\n[workspace]\nmembers = [\n    \"crates/parser\",\n    \"crates/compiler\",\n    \"crates/runtime\",\n]\n\n[workspace.package]\nversion = \"1.0.0\"\nedition = \"2021\"\n\n[workspace.dependencies]\nserde = { version = \"1.0\", features = [\"derive\"] }\n```\n\n### Features\n\n**Features** enable conditional compilation.\n\n```toml\n# Cargo.toml\n[features]\ndefault = [\"std\", \"async\"]\nstd = []\nasync = [\"tokio\"]\nno-std = []\n\n[dependencies]\ntokio = { version = \"1.0\", optional = true }\n```\n\n```rust\n// In code\n#[cfg(feature = \"async\")]\nuse tokio::runtime::Runtime;\n\n#[cfg(not(feature = \"no-std\"))]\nuse std::collections::HashMap;\n```\n\n### Build Scripts\n\n**Build scripts** run before compilation.\n\n```rust\n// build.rs\nfn main() {\n    // Generate code\n    println!(\"cargo:rerun-if-changed=src/schema.proto\");\n    \n    // Set environment variables\n    println!(\"cargo:rustc-env=BUILD_VERSION={}\", env!(\"CARGO_PKG_VERSION\"));\n    \n    // Link libraries\n    println!(\"cargo:rustc-link-lib=static=mylib\");\n}\n```\n\n### Cargo Profiles\n\n```toml\n[profile.dev]\nopt-level = 0          # No optimization\ndebug = true           # Include debug info\noverflow-checks = true # Runtime overflow checks\n\n[profile.release]\nopt-level = 3          # Maximum optimization\nlto = true             # Link-time optimization\ncodegen-units = 1      # Better optimization\nstrip = true           # Strip symbols\n\n[profile.test]\nopt-level = 1          # Some optimization for tests\ndebug = true\n```\n\n### Cargo Commands\n\n```bash\n# Build\ncargo build              # Debug build\ncargo build --release    # Release build\ncargo build --features async  # With features\n\n# Testing\ncargo test               # Run all tests\ncargo test --lib         # Only library tests\ncargo test -- --nocapture # Show println! output\ncargo test test_name     # Run specific test\n\n# Documentation\ncargo doc                # Generate docs\ncargo doc --open         # Open in browser\ncargo doc --no-deps      # Only current crate\n\n# Dependencies\ncargo update             # Update dependencies\ncargo tree               # Show dependency tree\ncargo tree --duplicates  # Find duplicate deps\ncargo audit              # Security audit\n\n# Code Quality\ncargo fmt                # Format code\ncargo clippy             # Run linter\ncargo clippy -- -W clippy::all  # All lints\n\n# Benchmarks\ncargo bench              # Run benchmarks\n\n# Clean\ncargo clean              # Remove build artifacts\n```\n\n## Rustfmt\n\n**Rustfmt** automatically formats Rust code.\n\n### Configuration\n\n```toml\n# rustfmt.toml\nedition = \"2021\"\nmax_width = 100\ntab_spaces = 4\nnewline_style = \"Unix\"\nuse_small_heuristics = \"Default\"\n\n# Formatting options\nfn_args_layout = \"Tall\"\nbrace_style = \"SameLineWhere\"\ncontrol_brace_style = \"AlwaysSameLine\"\n```\n\n### Usage\n\n```bash\n# Format all files\ncargo fmt\n\n# Format specific file\ncargo fmt -- src/main.rs\n\n# Check formatting (CI)\ncargo fmt -- --check\n\n# Format with specific config\ncargo fmt --config max_width=120\n```\n\n### Editor Integration\n\nMost editors auto-format on save:\n\n- **VS Code**: rust-analyzer extension\n- **Vim/Neovim**: rustfmt on save\n- **IntelliJ**: Rust plugin\n\n## Clippy\n\n**Clippy** is Rust's linter that catches common mistakes.\n\n### Installation\n\n```bash\nrustup component add clippy\n```\n\n### Usage\n\n```bash\n# Run clippy\ncargo clippy\n\n# All lints (including pedantic)\ncargo clippy -- -W clippy::all -W clippy::pedantic\n\n# Allow specific lint\ncargo clippy -- -A clippy::too_many_arguments\n\n# Deny specific lint\ncargo clippy -- -D clippy::unwrap_used\n\n# Fix automatically\ncargo clippy --fix\n```\n\n### Common Lints\n\n```rust\n// Clippy warns about:\n\n// 1. Unnecessary clones\nlet s = String::from(\"hello\");\nlet s2 = s.clone(); // Warning: unnecessary clone\n\n// 2. Unused variables\nlet _unused = 42; // Use underscore prefix\n\n// 3. Unnecessary unwrap\nlet value = option.unwrap(); // Warning: use expect or handle error\n\n// 4. Single char patterns\nif s == \"a\" { } // Should use 'a'\n\n// 5. Manual range checks\nif x >= 0 && x < 10 { } // Use (0..10).contains(&x)\n\n// 6. Redundant closures\nvec.iter().map(|x| x + 1).collect(); // Use .map(|&x| x + 1)\n```\n\n### Configuration\n\n```toml\n# .clippy.toml or clippy.toml\n\n# Allow specific lints\n# Or use attributes in code\n# #[allow(clippy::too_many_arguments)]\n```\n\n### In Code\n\n```rust\n#[allow(clippy::too_many_arguments)]\nfn complex_function(a: u32, b: u32, c: u32, d: u32, e: u32, f: u32) {\n    // ...\n}\n\n#[warn(clippy::all)]\nmod strict_module {\n    // All clippy lints enabled here\n}\n```\n\n## Documentation Tools\n\n### Writing Documentation\n\n```rust\n/// This function adds two numbers.\n///\n/// # Examples\n///\n/// ```\n/// use my_crate::add;\n///\n/// assert_eq!(add(2, 3), 5);\n/// ```\n///\n/// # Panics\n///\n/// This function will panic if the result overflows.\n///\n/// # Errors\n///\n/// Returns an error if...\npub fn add(a: u32, b: u32) -> u32 {\n    a + b\n}\n\n/// Module-level documentation\n///\n/// This module provides utilities for...\nmod utils {\n    // ...\n}\n```\n\n### Doc Tests\n\n```rust\n/// Calculates factorial\n///\n/// # Examples\n///\n/// ```\n/// # use my_crate::factorial;\n/// assert_eq!(factorial(5), 120);\n/// ```\n///\n/// ```should_panic\n/// # use my_crate::factorial;\n/// factorial(1000); // Panics on overflow\n/// ```\npub fn factorial(n: u32) -> u32 {\n    if n <= 1 { 1 } else { n * factorial(n - 1) }\n}\n```\n\n### Generating Documentation\n\n```bash\n# Generate docs\ncargo doc\n\n# Open in browser\ncargo doc --open\n\n# Private items too\ncargo doc --document-private-items\n\n# All dependencies\ncargo doc --all-features\n\n# Serve docs locally\ncargo doc --no-deps && python3 -m http.server --directory target/doc\n```\n\n### Documentation Attributes\n\n```rust\n#[doc(hidden)]\npub fn internal_function() {\n    // Hidden from public docs\n}\n\n#[doc(alias = \"add\")]\n#[doc(alias = \"sum\")]\npub fn combine(a: u32, b: u32) -> u32 {\n    a + b\n}\n```\n\n## Testing Frameworks\n\n### Built-in Testing\n\n```rust\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_basic() {\n        assert_eq!(2 + 2, 4);\n    }\n    \n    #[test]\n    #[should_panic]\n    fn test_panic() {\n        panic!(\"This should panic\");\n    }\n    \n    #[test]\n    #[ignore]\n    fn test_expensive() {\n        // Only run with cargo test -- --ignored\n    }\n}\n```\n\n### Test Organization\n\n```rust\n// tests/integration_test.rs\nuse my_crate;\n\n#[test]\nfn integration_test() {\n    // Integration test\n}\n\n// tests/common/mod.rs\npub fn setup() {\n    // Test setup\n}\n\n// benches/my_bench.rs\n#![feature(test)]\nextern crate test;\n\nuse test::Bencher;\n\n#[bench]\nfn bench_function(b: &mut Bencher) {\n    b.iter(|| {\n        // Code to benchmark\n    });\n}\n```\n\n### External Testing Crates\n\n#### Criterion (Benchmarking)\n\n```toml\n[dev-dependencies]\ncriterion = { version = \"0.5\", features = [\"html_reports\"] }\n\n[[bench]]\nname = \"my_bench\"\nharness = false\n```\n\n```rust\n// benches/my_bench.rs\nuse criterion::{black_box, criterion_group, criterion_main, Criterion};\n\nfn benchmark_function(c: &mut Criterion) {\n    c.bench_function(\"fib 20\", |b| b.iter(|| fibonacci(black_box(20))));\n}\n\ncriterion_group!(benches, benchmark_function);\ncriterion_main!(benches);\n```\n\n#### Proptest (Property-Based Testing)\n\n```toml\n[dev-dependencies]\nproptest = \"1.0\"\n```\n\n```rust\nuse proptest::prelude::*;\n\nproptest! {\n    #[test]\n    fn test_addition(a in 0u32..1000, b in 0u32..1000) {\n        let result = a + b;\n        prop_assert!(result >= a);\n        prop_assert!(result >= b);\n    }\n}\n```\n\n#### Mockall (Mocking)\n\n```toml\n[dev-dependencies]\nmockall = \"0.11\"\n```\n\n```rust\nuse mockall::automock;\n\n#[automock]\ntrait Database {\n    fn get_user(&self, id: u64) -> Option<String>;\n}\n\n#[test]\nfn test_with_mock() {\n    let mut mock_db = MockDatabase::new();\n    mock_db.expect_get_user()\n        .with(predicate::eq(1))\n        .returning(|_| Some(\"Alice\".to_string()));\n    \n    assert_eq!(mock_db.get_user(1), Some(\"Alice\".to_string()));\n}\n```\n\n## CI/CD for Rust\n\n### GitHub Actions\n\n```yaml\n# .github/workflows/rust.yml\nname: Rust\n\non:\n  push:\n    branches: [ main ]\n  pull_request:\n    branches: [ main ]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v3\n    \n    - name: Install Rust\n      uses: actions-rs/toolchain@v1\n      with:\n        toolchain: stable\n        components: rustfmt, clippy\n        override: true\n    \n    - name: Cache dependencies\n      uses: actions/cache@v3\n      with:\n        path: |\n          ~/.cargo/bin/\n          ~/.cargo/registry/index/\n          ~/.cargo/registry/cache/\n          ~/.cargo/git/db/\n          target/\n        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}\n    \n    - name: Format check\n      run: cargo fmt -- --check\n    \n    - name: Clippy\n      run: cargo clippy -- -D warnings\n    \n    - name: Build\n      run: cargo build --verbose\n    \n    - name: Test\n      run: cargo test --verbose\n    \n    - name: Build docs\n      run: cargo doc --no-deps\n    \n  coverage:\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v3\n    \n    - name: Install Rust\n      uses: actions-rs/toolchain@v1\n      with:\n        toolchain: stable\n    \n    - name: Run tests with coverage\n      uses: actions-rs/cargo@v1\n      with:\n        command: test\n        args: --all-features\n    \n    - name: Upload coverage\n      uses: codecov/codecov-action@v3\n```\n\n### GitLab CI\n\n```yaml\n# .gitlab-ci.yml\nimage: rust:latest\n\nstages:\n  - test\n  - build\n  - deploy\n\nvariables:\n  CARGO_HOME: $CI_PROJECT_DIR/.cargo\n\ncache:\n  paths:\n    - .cargo/\n    - target/\n\ntest:\n  stage: test\n  script:\n    - rustup component add rustfmt clippy\n    - cargo fmt -- --check\n    - cargo clippy -- -D warnings\n    - cargo test --all-features\n\nbuild:\n  stage: build\n  script:\n    - cargo build --release\n  artifacts:\n    paths:\n      - target/release/\n\ndeploy:\n  stage: deploy\n  script:\n    - echo \"Deploy to production\"\n  only:\n    - main\n```\n\n### Pre-commit Hooks\n\n```bash\n# .git/hooks/pre-commit\n#!/bin/bash\n\n# Format check\ncargo fmt -- --check || {\n    echo \"Code is not formatted. Run 'cargo fmt'\"\n    exit 1\n}\n\n# Clippy\ncargo clippy -- -D warnings || {\n    echo \"Clippy found issues\"\n    exit 1\n}\n\n# Tests\ncargo test || {\n    echo \"Tests failed\"\n    exit 1\n}\n```\n\n## Best Practices\n\n1. **Always format**: `cargo fmt` before committing\n2. **Run Clippy**: Fix warnings before merging\n3. **Write docs**: Document public APIs\n4. **Test coverage**: Aim for high test coverage\n5. **CI/CD**: Automate checks in CI\n6. **Dependency updates**: Regularly update with `cargo update`\n7. **Security**: Run `cargo audit` for vulnerabilities\n8. **Performance**: Use `cargo bench` for benchmarks\n\n## Useful Tools\n\n- **cargo-watch**: Auto-run commands on file changes\n- **cargo-expand**: Expand macros\n- **cargo-udeps**: Find unused dependencies\n- **cargo-tree**: Visualize dependency tree\n- **cargo-audit**: Security audit\n- **cargo-outdated**: Check for outdated dependencies\n- **cargo-deny**: Lint dependencies\n- **cargo-machete**: Remove unused dependencies",
  "difficulty": "intermediate",
  "estimatedTime": 50,
  "prerequisites": [
    "lesson-18-packages",
    "lesson-19-crates"
  ],
  "codeExamples": [
    {
      "id": "ex-83-1-cargo-workspace",
      "title": "Cargo Workspace",
      "description": "Setting up a Cargo workspace",
      "code": "// Workspace structure:\n// my-project/\n//   Cargo.toml (workspace root)\n//   crates/\n//     parser/\n//       Cargo.toml\n//       src/lib.rs\n//     compiler/\n//       Cargo.toml\n//       src/lib.rs\n\n// Cargo.toml (workspace root)\n/*\n[workspace]\nmembers = [\"crates/parser\", \"crates/compiler\"]\n\n[workspace.package]\nversion = \"1.0.0\"\nedition = \"2021\"\n\n[workspace.dependencies]\nserde = { version = \"1.0\", features = [\"derive\"] }\n*/\n\n// crates/parser/Cargo.toml\n/*\n[package]\nname = \"parser\"\nversion.workspace = true\nedition.workspace = true\n\n[dependencies]\nserde.workspace = true\n*/\n\n// Example: Using workspace dependencies\nfn main() {\n    println!(\"Workspace allows sharing dependencies and version management\");\n    println!(\"All crates in workspace share same dependency versions\");\n    println!(\"Build all: cargo build --workspace\");\n    println!(\"Test all: cargo test --workspace\");\n}",
      "explanation": "Cargo workspaces allow managing multiple related crates together. They share dependency versions and can be built/tested together. This is essential for large projects with multiple components.",
      "language": "rust"
    },
    {
      "id": "ex-83-2-clippy-lints",
      "title": "Clippy Lints",
      "description": "Common Clippy warnings and fixes",
      "code": "// Clippy will warn about these:\n\n// 1. Unnecessary clone\nfn bad_clone() {\n    let s = String::from(\"hello\");\n    let s2 = s.clone(); // Clippy: unnecessary clone\n    println!(\"{}\", s2);\n}\n\n// Fixed:\nfn good_clone() {\n    let s = String::from(\"hello\");\n    let s2 = &s; // Just borrow\n    println!(\"{}\", s2);\n}\n\n// 2. Unnecessary unwrap\nfn bad_unwrap() {\n    let opt = Some(42);\n    let value = opt.unwrap(); // Clippy: use expect or handle error\n    println!(\"{}\", value);\n}\n\n// Fixed:\nfn good_unwrap() {\n    let opt = Some(42);\n    match opt {\n        Some(value) => println!(\"{}\", value),\n        None => println!(\"No value\"),\n    }\n}\n\n// 3. Single char string\nfn bad_char() {\n    let s = \"hello\";\n    if s == \"a\" { } // Clippy: use 'a' instead\n}\n\n// Fixed:\nfn good_char() {\n    let s = \"hello\";\n    if s == 'a' { } // Use char literal\n}\n\n// 4. Manual range check\nfn bad_range(x: u32) -> bool {\n    x >= 0 && x < 10 // Clippy: use range.contains\n}\n\n// Fixed:\nfn good_range(x: u32) -> bool {\n    (0..10).contains(&x)\n}\n\nfn main() {\n    println!(\"Run 'cargo clippy' to see these warnings\");\n    println!(\"Clippy helps write idiomatic Rust code!\");\n}",
      "explanation": "Clippy catches common mistakes and suggests improvements. It helps write idiomatic Rust code. Many warnings can be auto-fixed with 'cargo clippy --fix'.",
      "language": "rust"
    },
    {
      "id": "ex-83-3-doc-tests",
      "title": "Documentation Tests",
      "description": "Writing and running doc tests",
      "code": "/// Adds two numbers together.\n///\n/// # Examples\n///\n/// ```\n/// use my_crate::add;\n/// assert_eq!(add(2, 3), 5);\n/// ```\n///\n/// # Panics\n///\n/// This function will panic on overflow:\n///\n/// ```should_panic\n/// # use my_crate::add;\n/// add(u32::MAX, 1);\n/// ```\npub fn add(a: u32, b: u32) -> u32 {\n    a.checked_add(b).expect(\"Addition overflow\")\n}\n\n/// Calculates factorial.\n///\n/// # Examples\n///\n/// ```\n/// # use my_crate::factorial;\n/// assert_eq!(factorial(5), 120);\n/// assert_eq!(factorial(0), 1);\n/// ```\npub fn factorial(n: u32) -> u32 {\n    match n {\n        0 | 1 => 1,\n        _ => n * factorial(n - 1),\n    }\n}\n\n/// Processes a vector of numbers.\n///\n/// # Examples\n///\n/// ```\n/// # use my_crate::process;\n/// let numbers = vec![1, 2, 3];\n/// let result = process(&numbers);\n/// assert_eq!(result, 6);\n/// ```\npub fn process(numbers: &[u32]) -> u32 {\n    numbers.iter().sum()\n}\n\nfn main() {\n    println!(\"Doc tests run with: cargo test --doc\");\n    println!(\"They ensure examples in documentation are correct!\");\n}",
      "explanation": "Doc tests are code examples in documentation that are automatically tested. They ensure documentation stays up-to-date and examples work correctly. Run with 'cargo test --doc'.",
      "language": "rust"
    }
  ],
  "exercises": [
    {
      "id": "exercise-83-1",
      "title": "Fix Clippy Warnings",
      "description": "Fix Clippy warnings in this code!",
      "starterCode": "fn process_data(data: Vec<String>) -> Vec<String> {\n    let mut result = Vec::new();\n    for item in data {\n        let cloned = item.clone();\n        result.push(cloned);\n    }\n    result\n}\n\nfn main() {\n    let data = vec![String::from(\"hello\"), String::from(\"world\")];\n    let result = process_data(data);\n    println!(\"{:?}\", result);\n}",
      "solution": "fn process_data(data: Vec<String>) -> Vec<String> {\n    // Clippy suggests: no need to clone, just return data\n    // Or if we need to modify: use map\n    data.into_iter().collect()\n    // Or: data (if no modification needed)\n}\n\nfn main() {\n    let data = vec![String::from(\"hello\"), String::from(\"world\")];\n    let result = process_data(data);\n    println!(\"{:?}\", result);\n}",
      "hints": [
        "Clippy will warn about unnecessary clone",
        "Consider if cloning is really needed",
        "Use into_iter() if consuming the vector"
      ],
      "difficulty": "easy"
    }
  ]
}

